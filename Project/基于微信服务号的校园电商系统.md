# 基于微信服务号的校园电商系统

该项目是与学院合作推出的校园电商系统，系统总体框架包括了三个模块，分别是前端展示模块，商铺模块以及后台管理员模块。其中前端展示模块使用SUI MOBILE进行响应式设计，而后端系统中的商铺模块以及管理员模块这是基于Spring，SpringMVC和MyBatis框架进行设计的。
本人主要负责的模块是商铺模块，主要内容包括： 商铺模块中的业务信息数据库的设计，如商铺信息表、商铺类别信息表和商铺产品信息表。 商铺模块中的服务端接口开发，如商铺的添加、商铺的查询、商铺所上传图片的处理等等。 由于本人所负责的模块所涉及的数据库读写较多，为了提高数据库的读写性能，在Dao层实现了数据库的读写分离。

## 数据库读写分离的实现

第一个步骤：配置主从同步：在主库中打开BinLog，然后再从库中打开RelayLog，然后在主库中设立一个连接账号，从库从此连接账号连接主库设立主从关系。
第二个步骤：编写一个DynamicDataSource类继承AbstractRoutingDataSource并重写其determineCurrentLookUpKey方法去决定返回哪一个数据源。
第三个步骤：编写了一个拦截器去拦截MyBatis对数据库操作的一些方法，通过分析这些方法对数据库的读写操作从而决定哪一个数据源。
第四个步骤：在Spring-dao中完成相关数据源的配置，最后将数据源添加到LazyConnectionDataSourceProxy中去。

使用**AbstractRoutingDataSource+aop+annotation**在dao层决定数据源。
本项目采用了mybatis， 可以将读写分离放在ORM层，比如mybatis可以通过mybatis plugin拦截sql语句，所有的insert/update/delete都访问master库，所有的select 都访问salve库，这样对于dao层都是透明。 plugin实现时可以通过注解或者分析语句是读写方法来选定主从库。不过这样依然有一个问题， 也就是不支持事务， 所以我们还需要重写一下DataSourceTransactionManager， 将read-only的事务扔进读库， 其余的有读有写的扔进写库。

## 在项目当中所遇到的难题以及解决方案

- 在商铺DAO层当中，主要包括的就是对商铺的增删改查操作，然后在对商铺进行查操作的时候，查询条件包括很多，如店铺的owner，Id，所属类别，店铺当前的状态以及模糊查询店铺名。如果要对这么多个条件一一查询回导致大量的代码重复以及查询效率低下，因此我们想到的解决方案是使用商铺实体类包装查询条件，然后利用mybatis中的if标签对查询条件进行判断然后调用相应的sql查询语句，返回对应查询条件的查询结果。
- 在开发商铺Controller层和Service层的时候，如对于商铺注册这个业务功能，我们在Controller层中调用Service层中的注册商铺方法时候，我们需要知道当前店铺的注册是否成功，如果不成功，出现的错误是什么等一系列信息返回给Controller层进行相应的处理，从而才能是用户知道商铺的注册是否成功，因此需要在这两个层之中进行一定的数据信息传递。我们的解决方案是定义了一个dto类ShopExecution，里面包含了商铺注册状态的信息以及商铺实体类等等，利用这个类来进行Controller层和Service层之间的数据交互，以保证前后台的数据的正确交互。

## 定期备份数据的实现
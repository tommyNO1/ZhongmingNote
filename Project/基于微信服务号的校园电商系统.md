# 基于微信服务号的校园电商系统

该项目是与学院合作推出的校园电商系统，系统总体框架包括了三个模块，分别是前端展示模块，商铺模块以及后台管理员模块。其中前端展示模块使用SUI MOBILE进行响应式设计，而后端系统中的商铺模块以及管理员模块这是基于Spring，SpringMVC和MyBatis框架进行设计的。
本人主要负责的模块是商铺模块，主要内容包括： 商铺模块中的业务信息数据库的设计，如商铺信息表、商铺类别信息表和商铺产品信息表。 商铺模块中的服务端接口开发，如商铺的添加、商铺的查询、商铺所上传图片的处理等等。 由于本人所负责的模块所涉及的数据库读写较多，为了提高数据库的读写性能，在Dao层实现了数据库的读写分离。

## Dao层
商铺模块的Dao层主要包括商铺类别的Dao以及商铺的Dao，其中商铺的Dao包括以下接口
```java
    /*
     * 返回queryShopList总数
     * @param shopCondition
     * @return
     * */
    int queryShopCount(@Param("shopCondition") Shop shopCondition);

    /*
     * 分页查询店铺，可输入的条件有：店铺名（模糊），店铺状态，店铺类别，区域Id，owner
     * @Param shopCondition
     * @Param rowIndex 从第几行开始取数据
     * @Param pageSize 返回的条数
     * @return
     * */
    List<Shop> queryShopList(@Param("shopCondition") Shop shopCondition, @Param("rowIndex") int rowIndex, @Param("pageSize") int pageSize);

    /*
     * 通过shop id 查询店铺
     * @param shopId
     * @return
     * */
    Shop queryByShopId(long shopId);

    /*
     * 新增店铺
     * @param shop
     * @return
     * */
    int insertShop(Shop shop);

    /*
     * 更新店铺信息
     * @param shop
     * */
    int updateShop(Shop shop);
```
其中queryShopList，queryShopById等方法的实现，需要获得实体类中一些属性的对象，因此需要使用MyBatis的resultMap进行映射，并使用<association>标签对外部类对象进行映射。

### Dao层中的Mapper映射
Limit语句（用于分页）
```mysql
SELECT ... FROM ... WHERE ... ORDER BY ... LIMIT ...  
```

LIMIT 子句可以被用于强制 SELECT 语句返回指定的记录数。LIMIT 接受一个或两个数字参数。参数必须是一个整数常量。如果给定两个参数，第一个参数指定第一个返回记录行的偏移量，第二个参数指定返回记录行的最大数目。
分页优化方法：
当数据量增加的时候，页数会越来越多，越往后分页，Limit语句的偏移量就会越大，速度就会越慢。因此我们选择通过子查询的方式来提高分页效率因为子查询是在索引上完成的，而普通查询是在数据文件上完成的，通常来说，索引文件要比数据文件小得多，所以操作起来更有效率。

## Service层

商铺的注册是如何实现的？

```Java
    /*
     * 新增店铺，包括新增图片
     * @param shop
     * @param shopImg
     * @return
     * @throws ShopOperationException
     * */
    ShopExecution addShop(Shop shop, ImageHolder shopImg) throws ShopOperationException;
```

在Service层，商铺的注册是通过addShop方法实现的，该方法传入两个参数，第一个是一个Shop实体类的对象，用于装载需要添加店铺的详细信息，第二个是一个ImageHolder类的对象，该对象包括了商铺图片的文件流和文件名称。
由于店铺注册涉及到数据库的读写操作，因此我将该方法进行事务管理起来，首先给店铺信息赋予初值如当前店铺状态，店铺的创建时间和最后修改时间，然后调用Dao层的方法对当前店铺信息写入数据库中，若写入成功，则开始处理商铺图片。
商铺的图片的处理主要分为两个部分：将图片经过处理后放到指定位置和将图片的相对目录存入数据库当中。首先需要先获得图片需要存放的目标地址，目标地址由三部分拼接构成，分别是basePath，relativePath和随机文件名。通过项目的里编写好的工具类获得这三个部分后，使用thumbnailator的方法对商品图片进行添加水印以及reszie的相关操作。最后创建相关目录，并将图片放置在目录当中，返回图片的相对路径，调用Dao层的update方法将图片的相对路径存储到数据库当中。

## 数据库读写分离的实现

第一个步骤：配置主从同步：在主库中打开BinLog，然后再从库中打开RelayLog，然后在主库中设立一个连接账号，从库从此连接账号连接主库设立主从关系。
第二个步骤：编写一个DynamicDataSource类继承AbstractRoutingDataSource并重写其determineCurrentLookUpKey方法去决定返回哪一个数据源。
第三个步骤：编写了一个拦截器去拦截MyBatis对数据库操作的一些方法，通过分析这些方法对数据库的读写操作从而决定哪一个数据源。
第四个步骤：在Spring-dao中完成相关数据源的配置，最后将数据源添加到LazyConnectionDataSourceProxy中去。

## 在项目当中所遇到的难题以及解决方案

- 在商铺DAO层当中，主要包括的就是对商铺的增删改查操作，然后在对商铺进行查操作的时候，查询条件包括很多，如店铺的owner，Id，所属类别，店铺当前的状态以及模糊查询店铺名。如果要对这么多个条件一一查询回导致大量的代码重复以及查询效率低下，因此我们想到的解决方案是使用商铺实体类包装查询条件，然后利用mybatis中的if标签对查询条件进行判断然后调用相应的sql查询语句，返回对应查询条件的查询结果。
- 在开发商铺Controller层和Service层的时候，如对于商铺注册这个业务功能，我们在Controller层中调用Service层中的注册商铺方法时候，我们需要知道当前店铺的注册是否成功，如果不成功，出现的错误是什么等一系列信息返回给Controller层进行相应的处理，从而才能是用户知道商铺的注册是否成功，因此需要在这两个层之中进行一定的数据信息传递。我们的解决方案是定义了一个dto类ShopExecution，里面包含了商铺注册状态的信息以及商铺实体类等等，利用这个类来进行Controller层和Service层之间的数据交互，以保证前后台的数据的正确交互。

